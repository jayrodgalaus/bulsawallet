<!DOCTYPE html>
<html>
<head>
	<title>Monthly Budget</title>
	<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	
	
	<style type="text/css">
		body{
			height: 100vh;
			overflow-y: scroll;
			overflow-x: hidden;
			
		}
		body::-webkit-scrollbar {
		  display: none; /* for Chrome, Safari, and Opera */
		}
		.bg-none{ background-color: rgba(0,0,0,0); }
		.bg-theme1 { background-color: #D4F1F4; }
		.bg-theme2 { background-color: #75E6DA; }
		.bg-theme3 { background-color: #189AB4; }
		.bg-theme4 { background-color: #05445E; }
		.bg-theme2-gradient {
			background: rgb(131,248,249);background: linear-gradient(148deg, rgba(131,248,249,1) 0%, rgba(81,200,212,1) 33%, rgba(26,178,190,1) 100%);}
		.bg-theme4-gradient {
			background: rgb(7,7,52);background: linear-gradient(328deg, rgba(7,7,52,1) 0%, rgba(11,22,67,1) 32%, rgba(23,69,141,1) 100%);}
		.bg-card-gradient {
			background: rgb(33,33,135);background: linear-gradient(148deg, rgba(55,55,243,1) 0%, rgba(0,212,255,1) 49%, rgba(53,255,215,1) 100%);}
		
		.color-theme1 { color: #D4F1F4; }
		.color-theme2 { color: #75E6DA; }
		.color-theme3 { color: #189AB4; }
		.color-theme4 { color: #05445E; }
		.radius-theme {border-radius: 10pt !important;}
		button.bg-theme:hover { background-color: #05445E; }
		button.color-theme:hover { color: #05445E; }
		.small { font-size: 9pt }
		.expense-filter{width: 28px; height: 28px; border-radius: 50%; padding: 0;}
		/* .expense-filter.active{background-color: #F0F0F0;} */
		.expense-filter>i{transform: translateY(-2px);  transition: all 0.2s;}
		.expense-button{border-radius: 50%; width: 22px; height: 22px; transition: all 0.2s;}
		.expense-button:active{background-color: #F0F0F0 !important; transition: all 0.2s;}
		.expense-button.dropdown-toggle::after{display: none !important;}
		.expense-allotment {transform: rotateY(0deg) translateY(-50%);transition: transform 0.8s;  
			backface-visibility: hidden; 
			position: absolute;
			top: 50%; right: 0.5rem;}
		.expense .flipped{transform: rotateY(180deg) translateY(-50%);transform-style: preserve-3d;		}
		#currentMonthYear{font-size: larger;}
		/* #calendarButton{font-size: larger;} */
		.calendar-month{width: 20%; flex-grow: 1; cursor: pointer;}
		.calendar-month:hover .card {background-color: #F0F0F0;}
		.calendar-month.active .card {background-color: #189AB4; color: white;}
		.dashboard-value{font-size: clamp(7pt, 15pt, 20pt) !important;}
		#petals{position: absolute; z-index: 0; width: 100%; opacity: 0; transition: all 0.3s; }
		#heart{ border: none; background-color: rgba(0,0,0,0); position: fixed; bottom: 1%; left: 50%; transform: translateX(-50%); z-index: 20; font-size: 9vw; animation: throb 0.7s alternate infinite ; }
		#welcomeModal .modal-content{background-color: #FFB6C1;}
		.carousel-indicators button{
			border-radius: 5px !important;
		}
		#carouselExampleIndicators .carousel-item .card{height: 30vh;}
		.invis{ opacity: 0 !important;}
		.focus-ring-0{--bs-focus-ring-color: rgba(var(--bs-success-rgb), 0)}
		#cashInInput{ border-radius: 0%; font-size: 20pt;}
	</style>
</head>
<body>
	<!-- MODALS -->
		<!-- messageModal -->
		<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModal" aria-hidden="true">
			<div class="modal-dialog w-75 mx-auto" style="margin-top: 25%; min-height: 20vh; height: 20vh;">
				  <div class="modal-content h-100">
						<div class="modal-body align-self-center">
							<div class="d-flex align-items-center justify-content-center h-100">
								<div id="message" class="small text-center"></div>
							</div>
						</div>
				  </div>
			</div>
	  	</div>
		<!-- deleteExpenseModal -->
		<div class="modal fade" id="deleteExpenseModal" tabindex="-1" aria-labelledby="deleteExpenseModal" aria-hidden="true">
			<div class="modal-dialog" style="margin-top: 25%;">
				  <div class="modal-content">
						<div class="modal-header">
							  <h1 class="modal-title fs-5" id="deleteExpenseModalLabel">Confirm</h1>
							  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							Are you sure you want to delete this expense?
						</div>
						<div class="modal-footer">
							  <button type="button" id="deleteExpense" class="btn btn-primary">Yes</button>
						</div>
				  </div>
			</div>
	  	</div>
	<header class="py-2">
		<div class="container">
			<div class="d-flex p-1">
				<div id="currentMonthYear" class="align-self-center fw-bold"></div>
			</div>
		</div>
	</header>
	<main>
		<div class="container">
			<div id="carouselExampleIndicators" class="carousel slide">
				<div class="carousel-indicators">
					<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
					<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
					<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
					<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="3" aria-label="Slide 4"></button>
				</div>
				<div class="carousel-inner">
				  <div class="carousel-item active">
					<div class="card bg-card-gradient color-theme1 border-0 radius-theme">
						<div class="card-body">
							<p>Current Balance</p>
							<h1><span id="totalBalance">0.00</span></h1>
							<br>
						</div>
					</div>
				  </div>
				  <div class="carousel-item">
					<div class="card bg-card-gradient color-theme1 border-0 radius-theme">
						<div class="card-body">
							<p>Total Budget</p>
							<h1><span id="totalBudget">0.00</span></h1>
							<br>
						</div>
					</div>
				  </div>
				  <div class="carousel-item">
					<div class="card bg-card-gradient color-theme1 border-0 radius-theme">
						<div class="card-body">
							<p>Total Allotted</p>
							<h1><span id="totalAllotted">0.00</span></h1>
							<br>
						</div>
					</div>
				  </div>
				  <div class="carousel-item">
					<div class="card bg-card-gradient color-theme1 border-0 radius-theme">
						<div class="card-body">
							<p>Total Spent</p>
							<h1><span id="totalSpent">0.00</span></h1>
							<br>
						</div>
					</div>
				  </div>
				</div>
			</div>
			<div class="container mt-3">
				<div class="row">
					<div class="col-4 px-1">
						<button class="btn w-100 btn-lg btn-primary bg-theme4 color-theme1 border-0 radius-theme" type="button" data-bs-toggle="offcanvas" data-bs-target="#cashInCanvas" aria-controls="cashInCanvas">
							<i class="fa-solid fa-coins"></i><br>
							<span class="small">Add Cash</span>
						</button>
					</div>
					<div class="col-4 px-1">
						<button class="btn w-100 btn-lg btn-primary bg-theme4 color-theme1 border-0 radius-theme" type="button" data-bs-toggle="offcanvas" data-bs-target="#expensesCanvas" aria-controls="expensesCanvas">
							<i class="fa-solid fa-file-invoice-dollar"></i><br>
							<span class="small">Expenses</span>
						</button>
					</div>
					<div class="col-4 px-1">
						<button class="btn w-100 btn-lg btn-primary bg-theme4 color-theme1 border-0 radius-theme" id="calendarButton" type="button" data-bs-toggle="offcanvas" data-bs-target="#calendarCanvas" aria-controls="calendarCanvas">
							<i class="fa-regular fa-calendar-days"></i><br>
							<span class="small">Calendar</span>
						</button>
					</div>
				</div>
			</div>
			<div class="container mt-3">
				<p></p>
				<div id="lastTransactionDiv"></div>
			</div>
		</div>
		
	</main>
	<!-- CALENDAR -->
	<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="calendarCanvas" aria-labelledby="calendarCanvas">
		<div class="offcanvas-header">
			<button type="button" class="btn-close invis" ></button>
			<p class="offcanvas-title flex-fill text-center fw-bold" id="calendarCanvasLabel">Calendar</p>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
		</div>
		<div class="offcanvas-body">
			<div class="card">
				<div class="card-body">
					<div class="d-flex">
						<button class="border-0 bg-none" id="previousYear">
							<i class="fa-solid fa-chevron-left"></i>
						</button>
						<div class="fs-5 flex-grow-1 text-center" id="calendarYear" yearindex=""></div>
						<button class="border-0 bg-none" id="nextYear">
							<i class="fa-solid fa-chevron-right"></i>
						</button>
					</div>
					
					<hr>
					<div class="d-flex">
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "0"><div class="card"><div class="card-body">JAN</div></div></div>
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "1"><div class="card"><div class="card-body">FEB</div></div></div>
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "2"><div class="card"><div class="card-body">MAR</div></div></div>
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "3"><div class="card"><div class="card-body">APR</div></div></div>							
					</div>
					<div class="d-flex">
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "4"><div class="card"><div class="card-body">MAY</div></div></div>
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "5"><div class="card"><div class="card-body">JUN</div></div></div>
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "6"><div class="card"><div class="card-body">JUL</div></div></div>
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "7"><div class="card"><div class="card-body">AUG</div></div></div>
					</div>
					<div class="d-flex">
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "8"><div class="card"><div class="card-body">SEP</div></div></div>
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "9"><div class="card"><div class="card-body">OCT</div></div></div>
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "10"><div class="card"><div class="card-body">NOV</div></div></div>
						<div class="calendar-month text-center small" data-bs-dismiss="offcanvas" month = "11"><div class="card"><div class="card-body">DEC</div></div></div>
					</div>
				</div>
			</div>
				
		</div>
	</div>
	<!-- CASH IN -->
	<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="cashInCanvas" aria-labelledby="cashInCanvas">
		<div class="offcanvas-header">
			<button type="button" class="btn-close invis" ></button>
			<p class="offcanvas-title flex-fill text-center fw-bold" id="cashInCanvasLabel">Add Cash</p>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
		</div>
		<div class="offcanvas-body d-flex flex-column">
			<input type="number" step="0.01" class="form-control form-control-lg bg-transparent border border-top-0 border-start-0 border-end-0 focus-ring focus-ring-0" placeholder="₱0.00" id="cashInInput">
			<p class="w-100 text-center small mt-2">Enter amount to add</p>
			<button class="btn w-100 p-2 btn-primary bg-theme4 color-theme1 border-0 radius-theme mt-auto" data-bs-dismiss="offcanvas" disabled id="saveCashIn">Save</button>
		</div>
	</div>
	<!-- EXPENSES -->
	<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="expensesCanvas" aria-labelledby="expensesCanvas">
		<div class="offcanvas-header">
			<button type="button" class="btn-close invis" ></button>
			<p class="offcanvas-title flex-fill text-center fw-bold" id="expensesCanvasLabel">Expenses</p>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
		</div>
		<div class="offcanvas-body d-flex flex-column">
			<div class="d-flex flex-row position-relative">
				<button id="toggleBalance" class="ms-auto border-0 bg-none fs-5"><i class="fa-solid fa-repeat" style="transform: translateY(-2px);"></i></button>
				<button id="toggleAll" class="expense-filter border-0 bg-none fs-5"><i class="fa-solid fa-arrow-rotate-right"></i></button>
				<button id="toggleFull" class="expense-filter border-0 bg-none fs-5"><i class="fa-solid fa-circle"></i></button>
				<button id="toggleHalfSpent" class="expense-filter border-0 bg-none fs-5"><i class="fa-regular fa-circle-dot"></i></button>
				<button id="toggleFullSPent" class="expense-filter border-0 bg-none fs-5"><i class="fa-regular fa-circle"></i></button>
			</div>
			<ul class="list-group list-group-flush" id="expensesList">
				<li class="list-group-item text-center">No expenses yet.</li>
			</ul>
			<button class="btn w-100 p-2 btn-primary bg-theme4 color-theme1 border-0 radius-theme mt-auto"  type="button" data-bs-toggle="offcanvas" data-bs-target="#newExpenseCanvas" aria-controls="newExpenseCanvas">New Expense</button>
		</div>
	</div>
	<!-- NEW EXPENSE -->
	<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="newExpenseCanvas" aria-labelledby="newExpenseCanvas">
		<div class="offcanvas-header">
			<button type="button" class="btn-close invis" ></button>
			<p class="offcanvas-title flex-fill text-center fw-bold" id="newExpenseCanvasLabel">New Expense</p>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
		</div>
		<div class="offcanvas-body d-flex flex-column">
			<input type="text" name="" class="form-control form-control-lg bg-transparent border border-top-0 border-start-0 border-end-0 focus-ring focus-ring-0" placeholder="Expense" id="inputNewExpense">
			<input type="number" name="" class="form-control mt-2 form-control-lg bg-transparent border border-top-0 border-start-0 border-end-0 focus-ring focus-ring-0" placeholder="Allotment" id="inputNewExpenseAllotment">
			<p class="w-100 text-center small mt-2">Enter expense allotment</p>
			<button class="btn w-100 p-2 btn-primary bg-theme4 color-theme1 border-0 radius-theme mt-auto" data-bs-toggle="offcanvas"  data-bs-target="#expensesCanvas" aria-controls="expensesCanvas" disabled id="saveNewExpense">Save</button>
		</div>
	</div>
	<!-- EXPENSE INFO -->
	<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="expenseCanvas" aria-labelledby="expenseCanvasLabel">
		<div class="offcanvas-header">
			<button type="button" class="btn-close invis" disabled></button>
			<p class="offcanvas-title flex-fill text-center fw-bold">Expense info</p>
			<button type="button" class="btn-close"  data-bs-toggle="offcanvas" data-bs-target="#expensesCanvas" aria-controls="expensesCanvas"></button>
		</div>
		<div class="offcanvas-body d-flex flex-column">
			<div class="card bg-card-gradient color-theme1 border-0 radius-theme">
				<div class="card-body">	
					<p>
						<span id="expenseCanvasLabel">Offcanvas</span>
						<button class="border border-0 color-theme4 bg-none color-theme" id="editExpenseName" type="button" data-bs-toggle="offcanvas" data-bs-target="#renameExpenseCanvas" aria-controls="renameExpenseCanvas">
							<i class="fa-solid fa-pen"></i>
						</button>
					</p>
					  <div class="d-flex ">
						  <h2 id="expenseCanvasAllotted"></h2>
						  <p><button class="border border-0 bg-none color-theme4" id="editExpenseAllotment" type="button" data-bs-toggle="offcanvas" data-bs-target="#editExpenseAllotmentCanvas" aria-controls="editExpenseAllotmentCanvas"><i class="fa-solid fa-pen"></i></button></p>
					  </div>
					  
					<button class="btn btn-sm bg-theme bg-theme4 float-end small text-light mt-2" id="payInFull">Pay in full</button>
				</div>
			</div>
			<div class="card border border-0 bg-none">
				<div class="card-body bg-none px-0">
					<div class="d-flex pb-2">
						<div>Particulars</div>
						<button class="border border-0 color-theme3 bg-none color-theme ms-auto p-0" id="addParticular"  data-bs-toggle="offcanvas" data-bs-target="#newParticularCanvas" aria-controls="newParticularCanvas">
							<i class="fa-solid fa-circle-plus fs-5"></i>
						</button>
					</div>
					<ul class="list-group list-group-flush small" id="particularsList">
						<li class="list-group-item text-center">No particulars yet.</li>
					</ul>
					<hr>
					<div class="d-flex">
						<div>Total</div>
						<div class="fw-bold ms-auto" id="particularsTotal"></div>
					</div>
				</div>
			</div>
			<button class="btn btn-danger w-100 p-2 color-theme1 border-0 radius-theme mt-auto" id="deleteExpenseBtn" type="button" data-bs-toggle="modal" data-bs-target="#deleteExpenseModal">Delete</button>
			
		</div>
	</div>
	<!-- RENAME EXPENSE -->
	<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="renameExpenseCanvas" aria-labelledby="renameExpenseCanvas">
		<div class="offcanvas-header">
			<button type="button" class="btn-close invis" disabled></button>
			<p class="offcanvas-title flex-fill text-center fw-bold" id="renameExpenseCanvasLabel">Rename Expense</p>
			<button type="button" class="btn-close focus-ring focus-ring-0" aria-label="Close" data-bs-toggle="offcanvas" data-bs-target="#expenseCanvas" aria-controls="expenseCanvas" index="-1" id=""></button>
		</div>
		<div class="offcanvas-body d-flex flex-column">
			<input type="text" name="" class="form-control form-control-lg bg-transparent border border-top-0 border-start-0 border-end-0 focus-ring focus-ring-0" placeholder="Expense Name" id="inputNewExpenseName">
			<p class="w-100 text-center small mt-2">Enter new expense name</p>
			<button type="button" id="saveNewExpenseName" class="btn w-100 p-2 btn-primary bg-theme4 color-theme1 border-0 radius-theme mt-auto" data-bs-toggle="offcanvas"  data-bs-target="#expenseCanvas" aria-controls="expenseCanvas" disabled>Save</button>
		</div>
	</div>
	
	<!-- EDIT EXPENSE ALLOTMENT -->
	<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="editExpenseAllotmentCanvas" aria-labelledby="editExpenseAllotmentCanvas">
		<div class="offcanvas-header">
			<button type="button" class="btn-close invis" disabled></button>
			<p class="offcanvas-title flex-fill text-center fw-bold" id="editExpenseAllotmentCanvasLabel">Edit Allotment</p>
			<button type="button" class="btn-close focus-ring focus-ring-0" aria-label="Close" data-bs-toggle="offcanvas" data-bs-target="#expenseCanvas" aria-controls="expenseCanvas" index="-1" id=""></button>
		</div>
		<div class="offcanvas-body d-flex flex-column">
			<input type="number" name="" class="form-control form-control-lg bg-transparent border border-top-0 border-start-0 border-end-0 focus-ring focus-ring-0" placeholder="Allotment" id="inputNewAllotment">
			<p class="w-100 text-center small mt-2">Enter new allotment</p>
			<button type="button" id="saveNewAllotment" class="btn w-100 p-2 btn-primary bg-theme4 color-theme1 border-0 radius-theme mt-auto" data-bs-toggle="offcanvas"  data-bs-target="#expenseCanvas" aria-controls="expenseCanvas" disabled>Save</button>
		</div>
	</div>
	<!-- NEW PARTICULAR -->
	<div class="offcanvas offcanvas-end border-0" tabindex="-1" id="newParticularCanvas" aria-labelledby="newParticularCanvas">
		<div class="offcanvas-header">
			<button type="button" class="btn-close invis" disabled></button>
			<p class="offcanvas-title flex-fill text-center fw-bold" id="newParticularCanvasLabel">Particular</p>
			
			<button type="button" class="btn-close"  data-bs-toggle="offcanvas" data-bs-target="#expenseCanvas" aria-controls="expenseCanvas"></button>
		</div>
		<div class="offcanvas-body d-flex flex-column">
			<input type="hidden" id="editIndex">
			<input type="hidden" value="" id="deleteParticularIndex">
			<input type="text" name="" class="form-control form-control-lg bg-transparent border border-top-0 border-start-0 border-end-0 focus-ring focus-ring-0" placeholder="Input Particular" id="inputNewParticular">
			<input type="number" name="" class="form-control form-control-lg bg-transparent border border-top-0 border-start-0 border-end-0 focus-ring focus-ring-0" placeholder="Price" id="inputNewParticularPrice">
			<p class="w-100 text-center small mt-2">Enter particular details</p>
			<div class="d-flex mt-auto">
				<button type="button" id="deleteParticular" index="" class="btn w-100 p-2 btn-danger border-0 radius-theme me-1" data-bs-toggle="offcanvas"  data-bs-target="#expenseCanvas" aria-controls="expenseCanvas">Delete</button>
				<button type="button" id="saveNewParticular" index="" class="btn w-100 p-2 btn-primary bg-theme4 color-theme1 border-0 radius-theme ms-1" data-bs-toggle="offcanvas"  data-bs-target="#expenseCanvas" aria-controls="expenseCanvas" disabled>Save</button>
			</div>
			
		</div>
	</div>
	
	<script>
		const storage = localStorage;
		const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
		const date = new Date();
		let month = months[date.getMonth()];
		let monthindex = date.getMonth();
		let year = (date.getFullYear()+"").slice(2);
		let currentYrValues = [];
		let currentMoValues = {};
		let years = [];
		let peso = new Intl.NumberFormat('en-US', {
		    style: 'currency',
		    currency: 'PHP',
		});
		let expenseIndex = -1;
		$('#totalBalance, #totalBudget, #totalAllotted, #totalSpent').text(peso.format($(this).text()))
		
		init();
				
		function init(){
			if(storage.getItem("yearValues") === null){
				let y = makeNewYear();
				let yearValues = [];
				yearValues[year] = y;
				currentYrValues = y;
				storage.setItem("yearValues",JSON.stringify(yearValues));
				currentMoValues = currentYrValues[date.getMonth()];
			}
			else{
				let parsed = JSON.parse(storage.getItem("yearValues"));
				if(parsed.length == parseInt(year)){
					let y = makeNewYear();
					let yearValues = parsed;
					yearValues[year] = y;
					currentYrValues = y;
					storage.setItem("yearValues",JSON.stringify(yearValues));
					currentMoValues = currentYrValues[date.getMonth()];
				}
				currentYrValues = parsed[year];
				currentMoValues = currentYrValues[monthindex];
			}
			setPageValues();
			setCurrentMonthYear(month,year);
		}
		function makeNewYear(){
			let yv = [];
			for (var i = 0; i < 12; i++) {
				let mv = {
					totalBudget: 0,
					totalRemaining: 0,
					totalAllotted: 0,
					expenses: []
				};

				yv.push(mv)
			}
			return yv;
		}
		function populate(){
			currentYrValues[date.getMonth() - 2] = currentMoValues;
			let yearValues = [];
			yearValues[24] = currentYrValues;
			storage.setItem("yearValues",JSON.stringify(yearValues));
		}
		function setPageValues(){
			$('#totalBudget').text(peso.format(currentMoValues.totalBudget))
			$('#totalAllotted').text(peso.format(currentMoValues.totalAllotted))
			$('#totalRemaining').text(peso.format(currentMoValues.totalRemaining))
			let balance = parseInt(currentMoValues.totalBudget);
			
			currentMoValues.expenses.forEach(function(item,index){
				particularsTotal = getParticularsTotal(index)
				balance -= particularsTotal
			})
			$('#totalBalance').text(peso.format(balance))
			let spent = parseInt(currentMoValues.totalBudget) - balance;
			$('#totalSpent').text(peso.format(spent))
			$('#expensesList').empty()
			if(currentMoValues.expenses.length > 0){
				currentMoValues.expenses.forEach(makeExpenseItem)
			}else{
				$('#expensesList').html(`<li class="list-group-item text-center">No expenses yet.</li>`)
			}
		}
		function setCurrentMonthYear(m,y){
			$('#currentMonthYear').text(m+" 20"+y);
			$('#calendarYear').text("20"+y);
			$('#calendarYear').attr('year',y)
		}
		function saveYrValues(m = null, y = 25){
			if(m != null){
				currentYrValues[m] = currentMoValues;
			}else{
				currentYrValues[date.getMonth()] = currentMoValues;
			}
			let parsed = JSON.parse(storage.getItem("yearValues"));
			let yearValues = parsed;
			// let yearValues = [];
			yearValues[y] = currentYrValues;
			storage.setItem("yearValues",JSON.stringify(yearValues));
			init()
		}
		function makeExpenseItem(item,index){
			let expname = item.name;
			let expallotment = peso.format(item.allotment);
			let actualExp = getParticularsTotal(index);
			let balance = peso.format(parseInt(item.allotment) - parseInt(actualExp));
			actualExp = peso.format(actualExp);
			let state = actualExp ==  expallotment ? 'fullspent' : (actualExp == peso.format(0) ? 'full': 'halfspent') 
			let template = `
				<li class="list-group-item ${state} expense-item">
					<div class="expense border-0 my-1">
						<div class="d-flex align-items-center small">
							<div class="expense-name fw-bold expense-button flex-grow-1" data-bs-toggle="offcanvas" data-bs-target="#expenseCanvas" aria-controls="expenseCanvas" index=${index} >${expname}</div>
							<div class="ms-auto">
								<div class="expense-allotment">${actualExp} / ${expallotment}</div>
								<div class="expense-allotment flipped"><span class="color-theme4">Balance</span> ${balance}</div>
							</div>
						</div>
					</div>
				</li>
			`;
			$('#expensesList').append(template)
			
		}
		function makeParticularItem(item,index){
			let particularName = item.name;
			let particularPrice = item.price;
			particularPrice = peso.format(particularPrice);
			
			let template = `
				<li class="list-group-item editParticularBtn" data-bs-toggle="offcanvas" data-bs-target="#newParticularCanvas" aria-controls="newParticularCanvas" index="${index}">
					<div class="d-flex">
						<div class="particularName flex-grow-1">${particularName}</div>
						<div class="">${particularPrice}</div>
					</div>
				</li>
			`;
			$('#particularsList').append(template)
		}
		function getParticularsTotal(i){
			let expense = currentMoValues.expenses[i];
			let actualExp = 0;
			if(expense.particulars.length >0){
				expense.particulars.forEach(function(p){
					actualExp += parseInt(p.price) 
				});
				
			}
			return actualExp;
			
		}
		function getTotalAllotted(m = monthindex){
			let expense = currentYrValues[m].expenses;
			let actualExp = 0;
			expense.forEach(function(p){
				actualExp += parseInt(p.allotment) 
			});
			return actualExp;
		}
		function showMessage(message){
			$('#message').text(message);
			$('#messageModal').modal('show');
		}
		$(function(){
			// welcome();
			$(document)
			.on('input','#cashInInput',function(){
				var val = $(this).val();
				if(val <= 0){
					$('#saveCashIn').attr('disabled','true').prop('disabled','true');

				}else{
					$('#saveCashIn').removeAttr('disabled').removeProp('disabled');
				}
			})
			.on('click','#editTotalBudget',function(){
				if(currentMoValues.expenses.length > 0){
					$('#resetTotalBudgetModal').modal('show')
				}else{
					$('#editTotalBudgetModal').modal('show')
				}
			})
			.on('click','#confirmResetTotalBudget',function(){
				currentMoValues.expenses = [];
				currentMoValues.totalBudget = 0;
				currentMoValues.totalAllotted = 0;
				currentMoValues.totalRemaining = 0;
			})
			.on('click','#saveCashIn',function(){

				let b = currentMoValues.totalBudget + parseInt($('#cashInInput').val());
				let a = currentMoValues.totalAllotted;
				let r = currentMoValues.totalRemaining;
				r = b-a;
				currentMoValues.totalBudget = parseInt(b);
				currentMoValues.totalRemaining = r;
				saveYrValues(monthindex,year)
				showMessage('Added budget successfully.')
			})
			.on('input','#inputNewExpenseAllotment',function(){
				let expallot = $('#inputNewExpenseAllotment').val();
				let expname = $('#inputNewExpense').val();
				if(expallot > currentMoValues.totalRemaining){
					$('#inputNewExpenseAllotment').val(currentMoValues.totalRemaining);
				}
				if(expallot.length > 0 && expname.length > 0){
					$('#saveNewExpense').removeAttr('disabled').removeProp('disabled')
				}else{
					$('#saveNewExpense').attr('disabled','true').prop('disabled','true')
				}
			})
			.on('click','#saveNewExpense',function(){
				let exp = {};
				let expname = $('#inputNewExpense').val();
				let expallot = $('#inputNewExpenseAllotment').val();
				if(parseInt(expallot) > currentMoValues.totalRemaining){
					$('#message').text('Insufficient funds!');
					$('#newExpenseModal').modal('hide');
					$('#messageModal').modal('show');
					return false;
				}else if(expallot == '' || expallot == null ||parseInt(expallot) <= 0|| currentMoValues.totalBudget == 0){
					$('#message').text('Value unacceptable!');
					$('#newExpenseModal').modal('hide');
					$('#messageModal').modal('show');
					return false;
				}
				exp = {name: expname, allotment: expallot, particulars: []};
				currentMoValues.expenses.push(exp);
				currentMoValues.totalAllotted += parseInt(expallot);
				currentMoValues.totalRemaining -= parseInt(expallot);
				saveYrValues(monthindex,year)
				$('#inputNewExpense').val('');
				$('#inputNewExpenseAllotment').val('');
				showMessage('Expense saved.')

			})
			.on('click','#toggleBalance',function(){
				$('.expense-allotment').toggleClass('flipped')
			})
			.on('click','#toggleAll',function(){
				$('.expense-item').fadeIn('fast')
			})
			.on('click','#toggleFull',function(){
				$('.expense-item.full').fadeIn('fast')
				$('.expense-item.halfspent, .expense-item.fullspent').fadeOut('fast')
			})
			.on('click','#toggleHalfSpent',function(){
				$('.expense-item.halfspent').fadeIn('fast')
				$('.expense-item').not('.halfspent').fadeOut('fast')
			})
			.on('click','#toggleFullSPent',function(){
				$('.expense-item.fullspent').fadeIn('fast')
				$('.expense-item').not('.fullspent').fadeOut('fast')
			})
			.on('click','.expense-filter', function(){
				$('.expense-filter').removeClass('color-theme3 active');
				$(this).addClass('color-theme3 active');
			})
			.on('click','.expense-button',function(){
				let i = $(this).attr('index')

				let exp = currentMoValues.expenses[i];
				let expname = exp.name;
				let allotment = exp.allotment;
				$('#expenseCanvasLabel').text(expname);
				$('#expenseCanvasAllotted').text(peso.format(allotment));
				$('#particularsList').empty();
				if(exp.particulars.length > 0){
					exp.particulars.forEach(makeParticularItem)
				}else{
					$('#particularsList').append('<li class="list-group-item text-center">No particulars yet.</li>');
				}
				let actualExp = 0;
				exp.particulars.forEach(function(p){
					actualExp += parseInt(p.price) 
				})
				actualExp = peso.format(actualExp);
				$('#particularsTotal').text(actualExp)
				$('#saveNewParticular').attr('index',i)
			})
			.on('click','#addParticular',function(){
				$('#deleteParticular').hide();

			})
			.on('input','#inputNewParticular',function(){
				let val = $(this).val().trim()
				let price = $('#inputNewParticularPrice').val()
				if(val.length > 0 && price.length > 0)
					$('#saveNewParticular').removeAttr('disabled').removeProp('disabled')
				else
					$('#saveNewParticular').attr('disabled','true').prop('disabled','true')
			})
			.on('input','#inputNewParticularPrice',function(){
				let i = $('#saveNewParticular').attr('index')
				let index = $('#editIndex').val()
				let actualTotal =getParticularsTotal(i);
				let price = parseInt($('#inputNewParticularPrice').val());
				let remainder = 0;
				if(index && index != ''){
					remainder = parseInt(currentMoValues.expenses[i].allotment) - (actualTotal - currentMoValues.expenses[i].particulars[index].price)
				}else{					
					remainder = parseInt(currentMoValues.expenses[i].allotment) - actualTotal;					
				}
				console.log(index)
				console.log(parseInt(currentMoValues.expenses[i].allotment)+":"+actualTotal)			
				if(price > remainder || price <= 0){
					$('#inputNewParticularPrice').val(remainder <= 0 ? 0 : remainder)
				}
				let particularprice = $('#inputNewParticularPrice').val();
				let particularname = $('#inputNewParticular').val();
				if(particularprice.length > 0 && particularname.length > 0)
					$('#saveNewParticular').removeAttr('disabled').removeProp('disabled')
				else
					$('#saveNewParticular').attr('disabled','true').prop('disabled','true')
				
			})
			.on('click','#saveNewParticular',function(){
				let i = $('#saveNewParticular').attr('index')
				let exp = {};
				let expname = $('#inputNewParticular').val();
				let expallot = $('#inputNewParticularPrice').val();
				let index = $('#editIndex').val();
				let message = 'Particular successfully created.'
				console.log(typeof index+ " "+ index != null && index != undefined && index != '');
				// return false;
				if(parseInt(expallot) > currentMoValues.expenses[i].allotment){
					$('#message').text('Insufficient funds!');
					$('#newExpenseModal').modal('hide');
					$('#messageModal').modal('show');
					return false;
				}else if(expallot == '' || expallot == null ||parseInt(expallot) <= 0){
					$('#message').text('Value is invalid!');
					$('#messageModal').modal('show');
					return false;
				}
				exp = {name: expname, price: parseInt(expallot)};
				expense = currentMoValues.expenses[i];
				if(index != null && index != undefined && index != ''){
					message = 'Particular successfully updated.'
					expense.particulars[index] = exp;					
				}else{
					expense.particulars.push(exp);
				}
				
				
				saveYrValues(monthindex,year);
				$('#particularsList').empty();
				expense.particulars.forEach(makeParticularItem);
				let actualExp = getParticularsTotal(i);
				actualExp = peso.format(actualExp);
				$('#particularsTotal').text(actualExp)
				$('#inputNewParticular').val('');
				$('#inputNewParticularPrice').val('');
				$('#editIndex').val('');
				$('#message').text(message);
				$('#messageModal').modal('show');
			})
			.on('click','.particularName',function(){
				if(!$(this).prev().is(':visible')){
					$(this).prev().fadeIn();
				}else{
					$('.particularBtns').fadeOut();
				}
			})
			.on('click','.editParticularBtn',function(){
				$('#deleteParticular').show();
				let index = $(this).attr('index');
				$('#editIndex').val(index);
				let i = $('#saveNewParticular').attr('index');
				let expense = currentMoValues.expenses[i];
				let name = expense.particulars[index].name
				let price = expense.particulars[index].price
				$('#inputNewParticular').val(name);
				$('#inputNewParticularPrice').val(price);

			})
			.on('click','#deleteParticular',function(){
				let i = $('#saveNewParticular').attr('index');
				let index = $('#editIndex').val();
				let expense = currentMoValues.expenses[i];
				expense.particulars.splice(index,1)
				currentMoValues.totalAllotted = getTotalAllotted();
				currentMoValues.totalRemaining = currentMoValues.totalBudget - currentMoValues.totalAllotted;
				saveYrValues(monthindex,year);
				$('#particularsList').empty();
				expense.particulars.forEach(makeParticularItem);
				let actualExp = getParticularsTotal(i);
				actualExp = peso.format(actualExp);
				$('#particularsTotal').text(actualExp)
				$('#message').text('Particular deleted')
				$('#editIndex').val('')
				$('#messageModal').modal('show')
			})
			.on('click','.expense',function(e){
				if($(e.target).hasClass('border') || $(e.target).hasClass('fa-solid')){return false;}
				$(this).find('.expense-allotment').toggleClass('flipped');
			})
			.on('click','#payInFull',function(){
				let i = $('#saveNewParticular').attr('index')			
				let expense = currentMoValues.expenses[i];
				let actualExp = parseInt(getParticularsTotal(i));
				if(actualExp == parseInt(expense.allotment)){
					$('#message').text('Expense already paid in full.');
					$('#messageModal').modal('show');
					return false;
				}
				let exp = {};
				let expname = $('#expenseCanvasLabel').text();
				exp = {name: expname, price: parseInt(expense.allotment) - actualExp};
				expense.particulars.push(exp);
				saveYrValues(monthindex,year);
				$('#particularsList').empty();
				expense.particulars.forEach(makeParticularItem);
				
				total = peso.format(expense.allotment);
				$('#particularsTotal').text(total)
			})
			.on('click','#calendarButton',function(){
				let m = monthindex;//months.findIndex(function(item){if(item == month){return true;}});
				$('.calendar-month[month='+m+']').addClass('active')
			})
			.on('click','.calendar-month',function(e){

				$('.calendar-month.active').removeClass('active');
				$('.calendar-month').each(function(){
					$(this).removeClass('active')
				})
				// $(e.target).addClass('active');
				let m = parseInt($(this).attr('month'));
				let yearindex = parseInt($('#calendarYear').attr('year'));
				let parsed = JSON.parse(storage.getItem("yearValues"));
				monthindex = m;
				year = yearindex;
				currentYrValues = parsed[yearindex];
				currentMoValues = currentYrValues[monthindex];
				month = months[m];
				setPageValues();
				setCurrentMonthYear(month, yearindex);
			})
			.on('click','#previousYear',function(){
				let y = parseInt($('#calendarYear').attr('year'));
				let prevyear = y-1
				if(y<=24){return false;}
				else{
					$('#calendarYear').attr('year',prevyear);
					$('#calendarYear').text("20"+prevyear);
				}
				
			})
			.on('click','#nextYear',function(){
				let y = parseInt($('#calendarYear').attr('year'));
				let currentYear = (date.getFullYear()+"").slice(2);
				if(y == currentYear){
					return false;
				}else{
					let nextyear = y+1
					$('#calendarYear').attr('year',nextyear);
					$('#calendarYear').text("20"+nextyear);
				}
				
			})
			.on('click','#welcomeModal',function(e){
				$('#petals').css({'z-index':0,'opacity':0})
				$('#loveAudio').animate({volume:0},1000,function(){$('#loveAudio')[0].currentTime = 0; $('#loveAudio')[0].pause();})		
			})
			.on('click','#editExpenseName',function(){

				$('#inputNewExpenseName').val($('#expenseCanvasLabel').text())
				let i = $('#saveNewParticular').attr('index');

			})
			.on('input','#inputNewExpenseName',function(){
				let val = $('#inputNewExpenseName').val();
				if(val.length == 0){
					$('#saveNewExpenseName').attr('disabled','true').prop('disabled','true');
				}else{
					$('#saveNewExpenseName').removeAttr('disabled').removeProp('disabled');
				}
			})
			.on('click','#saveNewExpenseName',function(){
				let name = $('#inputNewExpenseName').val();
				if(name == ''){return false;}
				let i = $('#saveNewParticular').attr('index');
				currentMoValues.expenses[i].name = name;
				$('#expenseCanvasLabel').text(name);
				saveYrValues(monthindex,year);
				$('#editExpenseNameModal').modal('hide');
			})
			.on('click','#editExpenseAllotment',function(){
				let i = $('#saveNewParticular').attr('index');
				let allotment = currentMoValues.expenses[i].allotment;
				$('#inputNewAllotment').val(allotment)
			})
			.on('input','#inputNewAllotment',function(){
				let i = $('#saveNewParticular').attr('index');
				let currentAllotment = parseInt(currentMoValues.expenses[i].allotment)
				let unallotted = parseInt(currentMoValues.totalRemaining);
				let newAllotment = parseInt($(this).val());
				let maxAllotment = currentAllotment + unallotted
				if(newAllotment >= maxAllotment){
					$(this).val(maxAllotment);
				}
				if($(this).val().length > 0){
					$('#saveNewAllotment').removeAttr('disabled').removeProp('disabled');
				}else{
					$('#saveNewAllotment').attr('disabled','true').prop('disabled','true');
				}
			})
			.on('click','#saveNewAllotment',function(){
				let i = $('#saveNewParticular').attr('index');
				let expense = currentMoValues.expenses[i];
				let newAllotment = parseInt($('#inputNewAllotment').val());
				let particularsTotal = getParticularsTotal(i);
				if(newAllotment <= 0){
					$('#message').text('Value unacceptable!')
					$('#resetExpenseAllotmentModal').modal('hide')
					$('#messageModal').modal('show')
					return false;
				}
				if(particularsTotal > newAllotment){
					$('#message').text('Value is less than the total of particulars.');
					$('#messageModal').modal('show')
					return false;
				}else{
					$('#message').text('Allotment updated')
					currentMoValues.expenses[i].allotment = parseInt(newAllotment);
					currentMoValues.totalAllotted = getTotalAllotted();
					currentMoValues.totalRemaining = currentMoValues.totalBudget - currentMoValues.totalAllotted ;
					saveYrValues(monthindex,year);
					$('#expenseCanvasAllotted').text(peso.format(newAllotment))
					$('#resetExpenseAllotmentModal').modal('hide')
					$('#messageModal').modal('show')
				}
			})
			.on('click','#saveNewAllotmentConfirm',function(){
				let i = $('#saveNewParticular').attr('index');
				let expense = currentMoValues.expenses[i];
				let newAllotment = parseInt($('#inputNewAllotment').val());
				$('#message').text('Allotment updated')
				currentMoValues.expenses[i].allotment = parseInt(newAllotment);
				currentMoValues.totalAllotted = getTotalAllotted();
				currentMoValues.totalRemaining = currentMoValues.totalBudget - currentMoValues.totalAllotted;
				currentMoValues.expenses[i].particulars = [];
				saveYrValues(monthindex,year);
				$('#particularsList').empty();
				$('#particularsTotal').text(peso.format(0))
				$('#expenseCanvasAllotted').text(peso.format(newAllotment))
				$('#resetExpenseAllotmentModal').modal('hide')
				$('#messageModal').modal('show')
			})
			.on('click','#deleteExpense',function(){
				let i = $('#saveNewParticular').attr('index');
				let expense = currentMoValues.expenses[i];
				let newAllotment = parseInt($('#inputNewAllotment').val());
				currentMoValues.expenses.splice(i,1)
				currentMoValues.totalAllotted = getTotalAllotted();
				currentMoValues.totalRemaining = currentMoValues.totalBudget - currentMoValues.totalAllotted;
				saveYrValues(monthindex,year);
				$('#particularsList').empty();
				$('#particularsTotal').text(peso.format(0))
				$('#expenseCanvasAllotted').text(peso.format(0))
				$('#deleteExpenseModal').modal('hide')
				$('#expenseCanvas').offcanvas('hide')
				$('#message').text('Expense deleted')
				$('#messageModal').modal('show')
			})

		})
	</script>
</body>
</html>